LLVM_CONFIG ?= $(shell which llvm-config-11)
CFLAGS += $(shell $(LLVM_CONFIG) --cflags)
LDFLAGS ?= $(shell $(LLVM_CONFIG) --ldflags --libs)
CFLGAGS += -I/usr/lib/llvm-11/include

ifeq ($(CC),cc)
	CC := $(shell $(LLVM_CONFIG) --bindir)/clang
endif

all: cloud

config.h:
	echo "// auto-generated by Makefile" > config.h
	echo "#define CLOUD_CLANG_PATH \"/usr/lib/llvm-11/bin/clang\"" >> config.h

obj/%.o: src/%.c $(wildcard src/*.h) config.h
	mkdir -vp obj && $(CC) -c $(CFLAGS) $< -o $@

cloud: $(SRC:src/%.c=obj/%.o)
	$(CC) $(CFLAGS) $^ -o $@ $(LDFLAGS)